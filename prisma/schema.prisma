generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////

enum AuthProvider {
  GOOGLE
  APPLE
}

model User {
  id           Int          @id @default(autoincrement())
  name         String?
  email        String
  provider     AuthProvider
  providerId   String
  profileImage String?
  level        Int          @default(1)
  exp          Int          @default(0)
  streakDays   Int          @default(0)
  lastLoginAt  DateTime     @default(now())
  registeredAt DateTime?
  createdAt    DateTime     @default(now())

  isNew Boolean @default(true)

  storyProgress     StoryProgress[]
  userEpisodes      UserEpisode[]
  dialogueBookmarks dialogueBookmark[]
  masteryProgress   MasteryProgress[]
  savedExpressions  SavedExpression[]
  characterFriends  CharacterFriend[]
  characterMessages CharacterMessage[]
  sentMessages      Message[]          @relation("SentMessages")
  receivedMessages  Message[]          @relation("ReceivedMessages")

  @@unique([email, provider])
}

//////////////////////////////////////////////////////
// STORY SYSTEM
//////////////////////////////////////////////////////

model Story {
  id          Int      @id @default(autoincrement())
  title       String
  koreanTitle String?
  category    String
  icon        String
  difficulty  Int      @default(1)
  description String?
  coverImage  String?
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  episodes        Episode[]
  storyCharacters StoryCharacter[]
  progress        StoryProgress[]
}

model Episode {
  id                Int      @id @default(autoincrement())
  storyId           Int
  title             String
  KoreanTitle       String?
  order             Int
  description       String?
  koreanDescription String?
  isPublished       Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  story        Story           @relation(fields: [storyId], references: [id])
  scenes       Scene[]
  rewards      EpisodeReward[]
  userEpisodes UserEpisode[]

  @@unique([storyId, order])
}

model Scene {
  id          Int      @id @default(autoincrement())
  episodeId   Int
  title       String
  koreanTitle String?
  order       Int
  bgImageUrl  String?
  audioUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  episode   Episode    @relation(fields: [episodeId], references: [id])
  dialogues dialogue[]

  @@unique([episodeId, order])
}

model dialogue {
  id             Int      @id @default(autoincrement())
  sceneId        Int
  order          Int
  type           String   @default("dialogue")
  characterName  String?
  characterId    Int?
  englishText    String
  koreanText     String
  charImageLabel String?
  imageUrl       String?
  audioUrl       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  scene     Scene      @relation(fields: [sceneId], references: [id])
  character Character? @relation(fields: [characterId], references: [id])

  bookmarks dialogueBookmark[]

  @@unique([sceneId, order])
}

//////////////////////////////////////////////////////
// STORY PROGRESS
//////////////////////////////////////////////////////

model StoryProgress {
  id          Int      @id @default(autoincrement())
  userId      Int
  storyId     Int
  progressPct Float    @default(0)
  isCompleted Boolean  @default(false)
  updatedAt   DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id])
  story Story @relation(fields: [storyId], references: [id])

  @@unique([userId, storyId])
}

model ReviewItem {
  id          Int     @id @default(autoincrement())
  episodeId   Int
  dialogueId  Int
  description String?
  order       Int

  @@unique([episodeId, dialogueId])
  @@index([episodeId])
}

enum QuizType {
  INTERPRETATION
  STORY_COMPREHENSION
  NEXT_DIALOGUE_PREDICTION
  GRAMMAR
}

enum QuizSourceType {
  EPISODE
  LESSON
}

model Quiz {
  id         Int            @id @default(autoincrement())
  sourceType QuizSourceType
  sourceId   Int
  type       QuizType

  questionEnglish String
  questionKorean  String?
  answerIndex     Int
  description     String?
  order           Int?

  isActive Boolean @default(true)

  options         QuizOption[]
  userQuizAnswers UserQuizAnswer[]

  @@index([sourceType, sourceId])
}

model QuizOption {
  id     Int    @id @default(autoincrement())
  quizId Int
  text   String
  order  Int

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([quizId])
}

model UserQuizAnswer {
  id            Int      @id @default(autoincrement())
  userId        Int
  quizId        Int
  attemptCount  Int
  selectedIndex Int
  isCorrect     Boolean
  createdAt     DateTime @default(now())

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@unique([userId, quizId, attemptCount])
  @@index([userId])
  @@index([quizId])
  @@index([userId, quizId])
}

enum EpisodeStage {
  STORY_IN_PROGRESS
  STORY_COMPLETED
  QUIZ_IN_PROGRESS
  QUIZ_COMPLETED
}

model UserEpisode {
  id        Int @id @default(autoincrement())
  userId    Int
  episodeId Int

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  lastSceneId  Int?
  currentStage EpisodeStage

  score       Int?
  isCompleted Boolean @default(false)

  meta    Json?
  user    User    @relation(fields: [userId], references: [id])
  episode Episode @relation(fields: [episodeId], references: [id])

  @@unique([userId, episodeId])
  @@index([userId])
  @@index([episodeId])
}

//////////////////////////////////////////////////////
// CHARACTER SYSTEM
//////////////////////////////////////////////////////

enum CharacterScope {
  GLOBAL
  STORY
}

model Character {
  id   Int            @id @default(autoincrement())
  scope CharacterScope @default(GLOBAL)

  name        String
  koreanName  String?
  avatarImage String?
  mainImage   String?
  description String
  personality String?
  aiPrompt    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  images     CharacterImage[]
  dialogues  dialogue[]
  friends    CharacterFriend[]
  messages   CharacterMessage[]
  storyLinks StoryCharacter[]
}

model StoryCharacter {
  id          Int      @id @default(autoincrement())
  storyId     Int
  characterId Int
  name        String
  createdAt   DateTime @default(now())

  story     Story     @relation(fields: [storyId], references: [id])
  character Character @relation(fields: [characterId], references: [id])

  @@unique([storyId, characterId])
}

model CharacterImage {
  id          Int      @id @default(autoincrement())
  characterId Int
  imageUrl    String
  label       String? // e.g., "happy", "angry", "sad", "neutral"
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  character Character @relation(fields: [characterId], references: [id])
}

//////////////////////////////////////////////////////
// CHARACTER FRIEND SYSTEM (USER ↔ CHARACTER)
//////////////////////////////////////////////////////

model CharacterFriend {
  id          Int       @id @default(autoincrement())
  userId      Int
  characterId Int
  affinity    Int       @default(0)
  isUnlocked  Boolean   @default(false)
  unlockedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user      User      @relation(fields: [userId], references: [id])
  character Character @relation(fields: [characterId], references: [id])

  @@unique([userId, characterId])
}

//////////////////////////////////////////////////////
// CHARACTER CHAT SYSTEM
//////////////////////////////////////////////////////

model CharacterMessage {
  id          Int      @id @default(autoincrement())
  userId      Int
  characterId Int
  content     String
  isFromUser  Boolean
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id])
  character Character @relation(fields: [characterId], references: [id])
}

//////////////////////////////////////////////////////
// dialogue BOOKMARK SYSTEM
//////////////////////////////////////////////////////

model dialogueBookmark {
  id         Int      @id @default(autoincrement())
  userId     Int
  dialogueId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id])
  dialogue dialogue @relation(fields: [dialogueId], references: [id])

  @@unique([userId, dialogueId])
}

//////////////////////////////////////////////////////
// EPISODE REWARD SYSTEM
//////////////////////////////////////////////////////

model EpisodeReward {
  id        Int        @id @default(autoincrement())
  episodeId Int
  type      RewardType
  payload   Json
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  episode Episode @relation(fields: [episodeId], references: [id])
}

enum RewardType {
  EXP
  CHARACTER_UNLOCK
  ITEM
}

//////////////////////////////////////////////////////
// MASTERY SYSTEM (REVIEW / SRS)
//////////////////////////////////////////////////////

model MasteryLevel {
  id    Int    @id @default(autoincrement())
  title String
  color String

  expressions Expression[]
  progress    MasteryProgress[]
}

model Expression {
  id             Int     @id @default(autoincrement())
  masteryLevelId Int
  english        String
  korean         String
  detail         String?

  level   MasteryLevel      @relation(fields: [masteryLevelId], references: [id])
  savedBy SavedExpression[]
}

model MasteryProgress {
  id             Int      @id @default(autoincrement())
  userId         Int
  masteryLevelId Int
  progressPct    Int      @default(0)
  lastReviewedAt DateTime @default(now())
  nextReviewAt   DateTime

  user  User         @relation(fields: [userId], references: [id])
  level MasteryLevel @relation(fields: [masteryLevelId], references: [id])

  @@unique([userId, masteryLevelId])
}

model SavedExpression {
  id           Int      @id @default(autoincrement())
  userId       Int
  expressionId Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id])
  expression Expression @relation(fields: [expressionId], references: [id])

  @@unique([userId, expressionId])
}

//////////////////////////////////////////////////////
// USER ↔ USER CHAT SYSTEM
//////////////////////////////////////////////////////

model Message {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isRead    Boolean  @default(false)

  senderId   Int
  receiverId Int

  sender   User @relation("SentMessages", fields: [senderId], references: [id])
  receiver User @relation("ReceivedMessages", fields: [receiverId], references: [id])
}
