generator client {
  provider     = "prisma-client"
  output       = "../src/generated/prisma"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

// GLOBAL
enum PublishStatus {
  DRAFT
  PUBLISHED
  HIDDEN
  ARCHIVED
  DELETED
}

//////////////////////////////////////////////////////
// USER
//////////////////////////////////////////////////////

enum AuthProvider {
  GOOGLE
  APPLE
}

model User {
  id           Int          @id @default(autoincrement())
  name         String?
  email        String
  provider     AuthProvider
  providerId   String
  profileImage String?
  level        Int          @default(1)
  exp          Int          @default(0)
  streakDays   Int          @default(0)
  lastLoginAt  DateTime     @default(now())
  registeredAt DateTime?
  createdAt    DateTime     @default(now())

  isNew Boolean @default(true)

  storyProgress     StoryProgress[]
  userEpisodes      UserEpisode[]
  dialogueBookmarks dialogueBookmark[]
  characterFriends  CharacterFriend[]
  characterMessages CharacterMessage[]

  @@unique([email, provider])
}

//////////////////////////////////////////////////////
// STORY SYSTEM
//////////////////////////////////////////////////////

model Story {
  id          Int           @id @default(autoincrement())
  title       String
  koreanTitle String?
  category    String
  icon        String
  difficulty  Int           @default(1)
  description String?
  coverImage  String?
  status      PublishStatus @default(DRAFT)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  episodes        Episode[]
  storyCharacters StoryCharacter[]
  progress        StoryProgress[]
  units           Unit[]
}

model Unit {
  id        Int           @id @default(autoincrement())
  storyId   Int
  order     Int
  color     String?
  status    PublishStatus @default(DRAFT)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  story Story @relation(fields: [storyId], references: [id], onDelete: SetNull)
}

model Episode {
  id                Int           @id @default(autoincrement())
  storyId           Int
  title             String
  koreanTitle       String?
  order             Int
  description       String?
  koreanDescription String?
  status            PublishStatus @default(DRAFT)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  story        Story           @relation(fields: [storyId], references: [id])
  scenes       Scene[]
  rewards      EpisodeReward[]
  userEpisodes UserEpisode[]

  @@unique([storyId, order])
}

model Scene {
  id          Int      @id @default(autoincrement())
  episodeId   Int
  title       String
  koreanTitle String?
  order       Int
  bgImageUrl  String?
  audioUrl    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  episode   Episode    @relation(fields: [episodeId], references: [id])
  dialogues dialogue[]

  @@unique([episodeId, order])
}

model dialogue {
  id             Int      @id @default(autoincrement())
  sceneId        Int
  order          Int
  type           String   @default("dialogue")
  characterName  String?
  characterId    Int?
  englishText    String
  koreanText     String
  charImageLabel String?
  imageUrl       String?
  audioUrl       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  scene     Scene      @relation(fields: [sceneId], references: [id])
  character Character? @relation(fields: [characterId], references: [id])

  bookmarks dialogueBookmark[]

  @@unique([sceneId, order])
}

//////////////////////////////////////////////////////
// STORY PROGRESS
//////////////////////////////////////////////////////

model StoryProgress {
  id          Int      @id @default(autoincrement())
  userId      Int
  storyId     Int
  progressPct Float    @default(0)
  isCompleted Boolean  @default(false)
  updatedAt   DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id])
  story Story @relation(fields: [storyId], references: [id])

  @@unique([userId, storyId])
}

model ReviewItem {
  id          Int     @id @default(autoincrement())
  episodeId   Int
  dialogueId  Int
  description String?
  order       Int

  @@unique([episodeId, dialogueId])
  @@index([episodeId])
}

enum QuizType {
  SENTENCE_BUILD // 단어 카드로 문장 전체 조립
  SENTENCE_CLOZE_BUILD // 문장 중간 빈칸 채우기
}

enum QuizSourceType {
  EPISODE
  LESSON
}

model Quiz {
  id         Int            @id @default(autoincrement())
  sourceType QuizSourceType
  sourceId   Int
  type       QuizType

  questionEnglish String
  questionKorean  String?
  description     String?
  order           Int?

  data Json?

  isActive        Boolean          @default(true)
  userQuizAnswers UserQuizAnswer[]

  @@index([sourceType, sourceId])
}

model UserQuizAnswer {
  id     Int @id @default(autoincrement())
  userId Int
  quizId Int

  isCorrect Boolean? // 정답/오답 개념이 있으면(선택)

  // 핵심: 타입별 제출값(텍스트/음성평가 결과 등)
  payload Json

  createdAt DateTime @default(now())

  quiz Quiz @relation(fields: [quizId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([quizId])
  @@index([userId, quizId])
}

enum EpisodeStage {
  STORY_IN_PROGRESS
  STORY_COMPLETED
  QUIZ_IN_PROGRESS
  QUIZ_COMPLETED
}

model UserEpisode {
  id        Int @id @default(autoincrement())
  userId    Int
  episodeId Int

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  lastSceneId  Int?
  currentStage EpisodeStage

  score       Int?
  isCompleted Boolean @default(false)

  meta    Json?
  user    User    @relation(fields: [userId], references: [id])
  episode Episode @relation(fields: [episodeId], references: [id])

  @@unique([userId, episodeId])
  @@index([userId])
  @@index([episodeId])
}

//////////////////////////////////////////////////////
// CHARACTER SYSTEM
//////////////////////////////////////////////////////

enum CharacterScope {
  GLOBAL
  STORY
}

model Character {
  id    Int            @id @default(autoincrement())
  scope CharacterScope @default(GLOBAL)

  name        String
  koreanName  String?
  avatarImage String?
  mainImage   String?
  description String
  personality String?
  aiPrompt    String?
  status      PublishStatus @default(DRAFT)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  images     CharacterImage[]
  dialogues  dialogue[]
  friends    CharacterFriend[]
  messages   CharacterMessage[]
  storyLinks StoryCharacter[]
}

model StoryCharacter {
  id          Int      @id @default(autoincrement())
  storyId     Int
  characterId Int
  name        String
  createdAt   DateTime @default(now())

  story     Story     @relation(fields: [storyId], references: [id])
  character Character @relation(fields: [characterId], references: [id])

  @@unique([storyId, characterId])
}

model CharacterImage {
  id          Int      @id @default(autoincrement())
  characterId Int
  imageUrl    String
  label       String? // e.g., "happy", "angry", "sad", "neutral"
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  character Character @relation(fields: [characterId], references: [id])
}

//////////////////////////////////////////////////////
// CHARACTER FRIEND SYSTEM (USER ↔ CHARACTER)
//////////////////////////////////////////////////////

model CharacterFriend {
  id          Int      @id @default(autoincrement())
  userId      Int
  characterId Int
  affinity    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id])
  character Character @relation(fields: [characterId], references: [id])

  @@unique([userId, characterId])
}

//////////////////////////////////////////////////////
// CHARACTER CHAT SYSTEM
//////////////////////////////////////////////////////

model CharacterMessage {
  id          Int      @id @default(autoincrement())
  userId      Int
  characterId Int
  content     String
  isFromUser  Boolean
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id])
  character Character @relation(fields: [characterId], references: [id])
}

//////////////////////////////////////////////////////
// dialogue BOOKMARK SYSTEM
//////////////////////////////////////////////////////

model dialogueBookmark {
  id         Int      @id @default(autoincrement())
  userId     Int
  dialogueId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id])
  dialogue dialogue @relation(fields: [dialogueId], references: [id])

  @@unique([userId, dialogueId])
}

//////////////////////////////////////////////////////
// EPISODE REWARD SYSTEM
//////////////////////////////////////////////////////

model EpisodeReward {
  id        Int        @id @default(autoincrement())
  episodeId Int
  type      RewardType
  payload   Json
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  episode Episode @relation(fields: [episodeId], references: [id])
}

enum RewardType {
  EXP
  CHARACTER_UNLOCK
  ITEM
}
